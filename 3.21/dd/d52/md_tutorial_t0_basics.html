<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Guardtime KSI c SDK: T0 - Basics</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Guardtime KSI c SDK
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "../../search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">T0 - Basics </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="autotoc_md7"></a>
Disclaimer</h1>
<p>For simplicity reasons, the error handling in this tutorial is mostly omitted. In practice almost all the functions in the SDK return a status code which value should be checked to be <a class="el" href="../../dd/df2/group__base.html#gga80cba280da561d1b02728cd946645197a457f8614f99ec7a367d4ca638f0fcdaa">KSI_OK</a>, which means all went well.</p>
<h1><a class="anchor" id="autotoc_md8"></a>
1. Preparation</h1>
<p>The first thing by using the SDK, we need to create a KSI context variable and initialize it. The context contains all the configurations and can be used for debugging. The following example shows the initialization of a new <a class="el" href="../../de/dea/group__base__types.html#ga4a5d4eaf93fb3a8f039c4853b912dc2d">KSI_CTX</a> object.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="../../d6/da9/ksi_8h.html">ksi/ksi.h</a>&gt;</span></div>
<div class="line"><a class="code" href="../../de/dea/group__base__types.html#ga4a5d4eaf93fb3a8f039c4853b912dc2d">KSI_CTX</a> *ksi = NULL; <span class="comment">/* Must be feed at the end. */</span></div>
<div class="line"><a class="code" href="../../dd/df2/group__base.html#ga61d7cd643994d0fc059a9fcc21489c15">KSI_CTX_new</a>(&amp;ksi); <span class="comment">/* Must be initialized only once per thread. */</span></div>
<div class="ttc" id="agroup__base__types_html_ga4a5d4eaf93fb3a8f039c4853b912dc2d"><div class="ttname"><a href="../../de/dea/group__base__types.html#ga4a5d4eaf93fb3a8f039c4853b912dc2d">KSI_CTX</a></div><div class="ttdeci">struct KSI_CTX_st KSI_CTX</div><div class="ttdef"><b>Definition:</b> types_base.h:78</div></div>
<div class="ttc" id="agroup__base_html_ga61d7cd643994d0fc059a9fcc21489c15"><div class="ttname"><a href="../../dd/df2/group__base.html#ga61d7cd643994d0fc059a9fcc21489c15">KSI_CTX_new</a></div><div class="ttdeci">int KSI_CTX_new(KSI_CTX **ctx)</div></div>
<div class="ttc" id="aksi_8h_html"><div class="ttname"><a href="../../d6/da9/ksi_8h.html">ksi.h</a></div></div>
</div><!-- fragment --><p>The next step would be to configure the context, as there are no default service locations to send the signing request to. Let's assume the signing service address is <code><a href="http://signservice.somehost:1234">http://signservice.somehost:1234</a></code> and it is authenticated by <code>user:key</code>. We can configure the signing service provider by calling <a class="el" href="../../dd/df2/group__base.html#ga1379702b89ffb73261d9eee73d35001c">KSI_CTX_setAggregator</a>.</p>
<div class="fragment"><div class="line"><a class="code" href="../../dd/df2/group__base.html#ga1379702b89ffb73261d9eee73d35001c">KSI_CTX_setAggregator</a>(ksi, <span class="stringliteral">&quot;http://signingservice.somehost:1234&quot;</span>, <span class="stringliteral">&quot;user&quot;</span>, <span class="stringliteral">&quot;key&quot;</span>);</div>
<div class="ttc" id="agroup__base_html_ga1379702b89ffb73261d9eee73d35001c"><div class="ttname"><a href="../../dd/df2/group__base.html#ga1379702b89ffb73261d9eee73d35001c">KSI_CTX_setAggregator</a></div><div class="ttdeci">int KSI_CTX_setAggregator(KSI_CTX *ctx, const char *uri, const char *loginId, const char *key)</div></div>
</div><!-- fragment --><p>The verification process may on some cases access to the extender service. Let's assume the extending service address is <code><a href="http://extendservice.somehost:4321">http://extendservice.somehost:4321</a></code> and it is authenticated by <code>user:key</code>. We can configure the service provider by calling <a class="el" href="../../dd/df2/group__base.html#ga15b39b8073f91698aa8879775cc4b71b">KSI_CTX_setExtender</a>.</p>
<div class="fragment"><div class="line"><a class="code" href="../../dd/df2/group__base.html#ga15b39b8073f91698aa8879775cc4b71b">KSI_CTX_setExtender</a>(ksi, <span class="stringliteral">&quot;http://signingservice.somehost:1234&quot;</span>, <span class="stringliteral">&quot;user&quot;</span>, <span class="stringliteral">&quot;key&quot;</span>);</div>
<div class="ttc" id="agroup__base_html_ga15b39b8073f91698aa8879775cc4b71b"><div class="ttname"><a href="../../dd/df2/group__base.html#ga15b39b8073f91698aa8879775cc4b71b">KSI_CTX_setExtender</a></div><div class="ttdeci">int KSI_CTX_setExtender(KSI_CTX *ctx, const char *uri, const char *loginId, const char *key)</div></div>
</div><!-- fragment --><p>To verify the responses from the service, we'll need to configure the publications file location. Usually it is located as a binary file on a http server. Guardtime hosts this file at <a href="http://verify.guardtime.com/ksi-publications.bin">http://verify.guardtime.com/ksi-publications.bin</a>. The file is added using <a class="el" href="../../dd/df2/group__base.html#ga11c407b1839124a4a0e0f9e2bab99498">KSI_CTX_setPublicationUrl</a> method.</p>
<div class="fragment"><div class="line"><a class="code" href="../../dd/df2/group__base.html#ga11c407b1839124a4a0e0f9e2bab99498">KSI_CTX_setPublicationUrl</a>(ksi, <span class="stringliteral">&quot;http://publication.somehost/ksi-publications.bin&quot;</span>);</div>
<div class="ttc" id="agroup__base_html_ga11c407b1839124a4a0e0f9e2bab99498"><div class="ttname"><a href="../../dd/df2/group__base.html#ga11c407b1839124a4a0e0f9e2bab99498">KSI_CTX_setPublicationUrl</a></div><div class="ttdeci">int KSI_CTX_setPublicationUrl(KSI_CTX *ctx, const char *uri)</div></div>
</div><!-- fragment --><p>But how can we verify the the publications file? The publications file is signed with PKI and the certificate must be issued by a known CA (by default the local truststore is consulted for this). We need to add some constraints to the certificate to make sure it is the correct one. To do so, we need to call KSI_CTX_setDefaultPubFileCertConstraints. The constraints are an array of OID and expected value pairs.</p>
<div class="fragment"><div class="line"><a class="code" href="../../dc/dfe/structKSI__CertConstraint__st.html">KSI_CertConstraint</a> arr[] = {</div>
<div class="line">                { <a class="code" href="../../dd/df2/group__base.html#ga7835d70427bebd12d92e3b6e851641f1">KSI_CERT_EMAIL</a>, <span class="stringliteral">&quot;publications@guardtime.com&quot;</span>},</div>
<div class="line">                { <a class="code" href="../../dd/df2/group__base.html#ga38667033e54daa5fe40c50b3db93b4ee">KSI_CERT_ORGANIZATION</a>, <span class="stringliteral">&quot;Guardtime&quot;</span> },</div>
<div class="line">                { NULL, NULL }</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><a class="code" href="../../dd/df2/group__base.html#gaa6e5b7e61db314ffbe7cae8fa7bf347c">KSI_CTX_setDefaultPubFileCertConstraints</a>(ctx, arr);</div>
<div class="ttc" id="agroup__base_html_ga38667033e54daa5fe40c50b3db93b4ee"><div class="ttname"><a href="../../dd/df2/group__base.html#ga38667033e54daa5fe40c50b3db93b4ee">KSI_CERT_ORGANIZATION</a></div><div class="ttdeci">#define KSI_CERT_ORGANIZATION</div><div class="ttdef"><b>Definition:</b> ksi.h:795</div></div>
<div class="ttc" id="agroup__base_html_ga7835d70427bebd12d92e3b6e851641f1"><div class="ttname"><a href="../../dd/df2/group__base.html#ga7835d70427bebd12d92e3b6e851641f1">KSI_CERT_EMAIL</a></div><div class="ttdeci">#define KSI_CERT_EMAIL</div><div class="ttdef"><b>Definition:</b> ksi.h:792</div></div>
<div class="ttc" id="agroup__base_html_gaa6e5b7e61db314ffbe7cae8fa7bf347c"><div class="ttname"><a href="../../dd/df2/group__base.html#gaa6e5b7e61db314ffbe7cae8fa7bf347c">KSI_CTX_setDefaultPubFileCertConstraints</a></div><div class="ttdeci">int KSI_CTX_setDefaultPubFileCertConstraints(KSI_CTX *ctx, const KSI_CertConstraint *arr)</div></div>
<div class="ttc" id="astructKSI__CertConstraint__st_html"><div class="ttname"><a href="../../dc/dfe/structKSI__CertConstraint__st.html">KSI_CertConstraint_st</a></div><div class="ttdef"><b>Definition:</b> types.h:150</div></div>
</div><!-- fragment --><p>There are some OID keys predefined (<a class="el" href="../../dd/df2/group__base.html#ga7835d70427bebd12d92e3b6e851641f1">KSI_CERT_EMAIL</a>, <a class="el" href="../../dd/df2/group__base.html#ga38667033e54daa5fe40c50b3db93b4ee">KSI_CERT_ORGANIZATION</a>, <a class="el" href="../../dd/df2/group__base.html#gad69a292a102d670dd6756b0d0d8b952a">KSI_CERT_COMMON_NAME</a>, <a class="el" href="../../dd/df2/group__base.html#gab7ecef7f5071a2c4a23b29d38e62d93f">KSI_CERT_COUNTRY</a>) for convenience but is not limited to them. The following example is equivalent (but less readable) as the previous one:</p>
<div class="fragment"><div class="line"><a class="code" href="../../dc/dfe/structKSI__CertConstraint__st.html">KSI_CertConstraint</a> arr[] = {</div>
<div class="line">                { <span class="stringliteral">&quot;1.2.840.113549.1.9.1&quot;</span>, <span class="stringliteral">&quot;publications@guardtime.com&quot;</span>},</div>
<div class="line">                { <span class="stringliteral">&quot;2.5.4.10&quot;</span>, <span class="stringliteral">&quot;Guardtime&quot;</span> },</div>
<div class="line">                { NULL, NULL }</div>
<div class="line">};</div>
<div class="line"><a class="code" href="../../dd/df2/group__base.html#gaa6e5b7e61db314ffbe7cae8fa7bf347c">KSI_CTX_setDefaultPubFileCertConstraints</a>(ctx, arr);</div>
</div><!-- fragment --><p>The context is ready to be used.</p>
<h1><a class="anchor" id="autotoc_md9"></a>
2. Offline Publications File</h1>
<p>If there is a need to load the publications file from the local file system, the file may be loaded using <a class="el" href="../../d4/d99/group__publications.html#ga5c2d2a3061a97841e3afc2fbcb8f7644">KSI_PublicationsFile_fromFile</a> or <a class="el" href="../../d4/d99/group__publications.html#ga3753608f4d39f38a8e662e609f4a1e7b">KSI_PublicationsFile_parse</a>. The second function is essentially the same as the parse function, but takes a file name as an argument and parses the contents.</p>
<div class="fragment"><div class="line"><a class="code" href="../../de/dea/group__base__types.html#ga4a5d4eaf93fb3a8f039c4853b912dc2d">KSI_CTX</a> *ksi = NULL;</div>
<div class="line"><a class="code" href="../../d4/d99/group__publications.html#ga14183de94642b129de416ac0c4379a50">KSI_PublicationsFile</a> *pubFile = NULL;</div>
<div class="line"> </div>
<div class="line"><a class="code" href="../../dd/df2/group__base.html#ga61d7cd643994d0fc059a9fcc21489c15">KSI_CTX_new</a>(&amp;ksi);      </div>
<div class="line"><a class="code" href="../../d4/d99/group__publications.html#ga5c2d2a3061a97841e3afc2fbcb8f7644">KSI_PublicationsFile_fromFile</a>(ksi, KSI_PUBLICATIONS_FILE, &amp;pubFile);</div>
<div class="line"><a class="code" href="../../dd/df2/group__base.html#gab34df88de75dcb095ab0b208cbe1364c">KSI_CTX_setPublicationsFile</a>(ksi, pubFile);</div>
<div class="ttc" id="agroup__base_html_gab34df88de75dcb095ab0b208cbe1364c"><div class="ttname"><a href="../../dd/df2/group__base.html#gab34df88de75dcb095ab0b208cbe1364c">KSI_CTX_setPublicationsFile</a></div><div class="ttdeci">int KSI_CTX_setPublicationsFile(KSI_CTX *ctx, KSI_PublicationsFile *var)</div></div>
<div class="ttc" id="agroup__publications_html_ga14183de94642b129de416ac0c4379a50"><div class="ttname"><a href="../../d4/d99/group__publications.html#ga14183de94642b129de416ac0c4379a50">KSI_PublicationsFile</a></div><div class="ttdeci">struct KSI_PublicationsFile_st KSI_PublicationsFile</div><div class="ttdef"><b>Definition:</b> publicationsfile.h:45</div></div>
<div class="ttc" id="agroup__publications_html_ga5c2d2a3061a97841e3afc2fbcb8f7644"><div class="ttname"><a href="../../d4/d99/group__publications.html#ga5c2d2a3061a97841e3afc2fbcb8f7644">KSI_PublicationsFile_fromFile</a></div><div class="ttdeci">int KSI_PublicationsFile_fromFile(KSI_CTX *ctx, const char *fileName, KSI_PublicationsFile **pubFile)</div></div>
</div><!-- fragment --><p>The SDK performs verification on the publications file only if it is the one to load it from the given publication URL. In this case the SDK assumes the user has verified the publication file (or if not the caller has made a conscious decision.). To verify the publications file call <a class="el" href="../../d4/d99/group__publications.html#gac953f6f771a1d18fa10d9f479f28829c">KSI_PublicationsFile_verify</a>.</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> res = <a class="code" href="../../d4/d99/group__publications.html#gac953f6f771a1d18fa10d9f479f28829c">KSI_PublicationsFile_verify</a>(pubFile);</div>
<div class="line"><span class="keywordflow">if</span> (res != <a class="code" href="../../dd/df2/group__base.html#gga80cba280da561d1b02728cd946645197a457f8614f99ec7a367d4ca638f0fcdaa">KSI_OK</a>) {</div>
<div class="line">        fprintf(stderr, <span class="stringliteral">&quot;Publications file not verified!\n&quot;</span>);</div>
<div class="line">} <span class="keywordflow">else</span> {</div>
<div class="line">        printf(<span class="stringliteral">&quot;Publications file verified.\n&quot;</span>);</div>
<div class="line">}</div>
<div class="ttc" id="agroup__base_html_gga80cba280da561d1b02728cd946645197a457f8614f99ec7a367d4ca638f0fcdaa"><div class="ttname"><a href="../../dd/df2/group__base.html#gga80cba280da561d1b02728cd946645197a457f8614f99ec7a367d4ca638f0fcdaa">KSI_OK</a></div><div class="ttdeci">@ KSI_OK</div><div class="ttdef"><b>Definition:</b> ksi.h:49</div></div>
<div class="ttc" id="agroup__publications_html_gac953f6f771a1d18fa10d9f479f28829c"><div class="ttname"><a href="../../d4/d99/group__publications.html#gac953f6f771a1d18fa10d9f479f28829c">KSI_PublicationsFile_verify</a></div><div class="ttdeci">int KSI_PublicationsFile_verify(const KSI_PublicationsFile *pubFile, KSI_CTX *ctx)</div></div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md10"></a>
2. Hashing</h1>
<p>Lets assume our data to be signed is stored in a variable called <code>data</code> and it's length is stored in <code>data_len</code>.</p>
<p>As only the hash of the original document is signed, we need to create a <a class="el" href="../../d7/d3b/group__hash.html#ga43edf212fcfe4da57b8b3e928e7c84ab">KSI_DataHash</a> object. This is usually done using the <a class="el" href="../../d7/d3b/group__hash.html#gae9211b745148aead8eb0a8929407451d">KSI_DataHasher</a> object where the data can be added to the hash calculation in chunks. In our example, the data is already stored in a single memory buffer and we can use the <a class="el" href="../../d7/d3b/group__hash.html#gac8984bdacd90956f2fd34e4d3ced1238">KSI_DataHash_create</a> function. We will use the <a class="el" href="../../d7/d3b/group__hash.html#ggaa4464779ee1e147860e0c119a1dec05ca73a7d78754b89e248c20e67587b4ea35">KSI_HASHALG_SHA2_256</a> algorithm.</p>
<div class="fragment"><div class="line"><a class="code" href="../../d7/d3b/group__hash.html#ga43edf212fcfe4da57b8b3e928e7c84ab">KSI_DataHash</a> *hsh = NULL; <span class="comment">/* Must be freed. */</span></div>
<div class="line"><a class="code" href="../../d7/d3b/group__hash.html#gac8984bdacd90956f2fd34e4d3ced1238">KSI_DataHash_create</a>(ksi, data, data_len, &amp;hsh);</div>
<div class="ttc" id="agroup__hash_html_ga43edf212fcfe4da57b8b3e928e7c84ab"><div class="ttname"><a href="../../d7/d3b/group__hash.html#ga43edf212fcfe4da57b8b3e928e7c84ab">KSI_DataHash</a></div><div class="ttdeci">struct KSI_DataHash_st KSI_DataHash</div><div class="ttdef"><b>Definition:</b> hash.h:52</div></div>
<div class="ttc" id="agroup__hash_html_gac8984bdacd90956f2fd34e4d3ced1238"><div class="ttname"><a href="../../d7/d3b/group__hash.html#gac8984bdacd90956f2fd34e4d3ced1238">KSI_DataHash_create</a></div><div class="ttdeci">int KSI_DataHash_create(KSI_CTX *ctx, const void *data, size_t data_length, KSI_HashAlgorithm algo_id, KSI_DataHash **hash)</div></div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md11"></a>
3. Cleanup</h1>
<p>As the final step we need to free all the allocated resources. Note that the KSI context may be reused as much as needed (within a single thread) and must not be created every time. It is also important to point out that the context must be freed last.</p>
<div class="fragment"><div class="line"><a class="code" href="../../d7/d3b/group__hash.html#gaf1fec51aed3fff221d7b094b1c42ed88">KSI_DataHash_free</a>(hsh);</div>
<div class="line"><a class="code" href="../../dd/df2/group__base.html#ga40d9e85aa8b1bd9218e8395e5a79838a">KSI_CTX_free</a>(ksi); <span class="comment">/* Must be freed last. */</span></div>
<div class="ttc" id="agroup__base_html_ga40d9e85aa8b1bd9218e8395e5a79838a"><div class="ttname"><a href="../../dd/df2/group__base.html#ga40d9e85aa8b1bd9218e8395e5a79838a">KSI_CTX_free</a></div><div class="ttdeci">void KSI_CTX_free(KSI_CTX *ctx)</div></div>
<div class="ttc" id="agroup__hash_html_gaf1fec51aed3fff221d7b094b1c42ed88"><div class="ttname"><a href="../../d7/d3b/group__hash.html#gaf1fec51aed3fff221d7b094b1c42ed88">KSI_DataHash_free</a></div><div class="ttdeci">void KSI_DataHash_free(KSI_DataHash *hash)</div></div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>
