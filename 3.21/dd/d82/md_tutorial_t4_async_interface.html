<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Guardtime KSI c SDK: T4 - Asynchronous Interface Tutorial</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Guardtime KSI c SDK
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "../../search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">T4 - Asynchronous Interface Tutorial </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="autotoc_md34"></a>
## Disclaimer</h1>
<p>For simplicity reasons, the error handling in this tutorial is mostly omitted. In practice almost all the functions in the SDK return a status code. If status code is <a class="el" href="../../dd/df2/group__base.html#gga80cba280da561d1b02728cd946645197a457f8614f99ec7a367d4ca638f0fcdaa">KSI_OK</a>, all went well.</p>
<p>Following tutorial will describe the signing interface in details. However, as the same practices apply also to the asynchronous extending interface, you will find applicable references.</p>
<h1><a class="anchor" id="autotoc_md35"></a>
## 1. Preparation</h1>
<p>For common preparation, see <a class="el" href="../../dd/d52/md_tutorial_t0_basics.html">Basics Tutorial</a>. After completion, initialize the asynchronous service provider.</p>
<div class="fragment"><div class="line"><a class="code" href="../../df/d8a/group__ksi__types.html#gad84c59bd3c6db9e15422f210fca7c695">KSI_AsyncService</a> *service = NULL; <span class="comment">/* Must be freed. */</span></div>
<div class="line"> </div>
<div class="line"><a class="code" href="../../d4/db6/group__asyncNetwork.html#ga556767df4d70b36226673f974c1470c1">KSI_SigningAsyncService_new</a>(ksi, &amp;service);</div>
<div class="ttc" id="agroup__asyncNetwork_html_ga556767df4d70b36226673f974c1470c1"><div class="ttname"><a href="../../d4/db6/group__asyncNetwork.html#ga556767df4d70b36226673f974c1470c1">KSI_SigningAsyncService_new</a></div><div class="ttdeci">int KSI_SigningAsyncService_new(KSI_CTX *ctx, KSI_AsyncService **service)</div></div>
<div class="ttc" id="agroup__ksi__types_html_gad84c59bd3c6db9e15422f210fca7c695"><div class="ttname"><a href="../../df/d8a/group__ksi__types.html#gad84c59bd3c6db9e15422f210fca7c695">KSI_AsyncService</a></div><div class="ttdeci">struct KSI_AsyncService_st KSI_AsyncService</div><div class="ttdef"><b>Definition:</b> types.h:125</div></div>
</div><!-- fragment --><p> (see <a class="el" href="../../d4/db6/group__asyncNetwork.html#ga95889faf55f1307bc36d3c0f779b1c08">KSI_ExtendingAsyncService_new</a> for extending)</p>
<p>Next, set up the <code>service</code>. Similarly to basic interface (see <a class="el" href="../../dc/d3c/md_tutorial_t1_signing.html">Signing Tutorial</a> or <a class="el" href="../../d5/dc7/md_tutorial_t3_extending.html">Extending Tutorial</a>), you need to configure service location to send the request to. Let's assume the service address is <code>ksi+tcp</code>://service.somehost:1234 and it is authenticated by <code>user:key</code>.</p>
<div class="fragment"><div class="line"><a class="code" href="../../d4/db6/group__asyncNetwork.html#gac7dcd524c5d4520d6c176721125d0a3b">KSI_AsyncService_setEndpoint</a>(service, <span class="stringliteral">&quot;ksi+tcp://service.somehost:1234&quot;</span>, <span class="stringliteral">&quot;user&quot;</span>, <span class="stringliteral">&quot;key&quot;</span>);</div>
<div class="ttc" id="agroup__asyncNetwork_html_gac7dcd524c5d4520d6c176721125d0a3b"><div class="ttname"><a href="../../d4/db6/group__asyncNetwork.html#gac7dcd524c5d4520d6c176721125d0a3b">KSI_AsyncService_setEndpoint</a></div><div class="ttdeci">int KSI_AsyncService_setEndpoint(KSI_AsyncService *service, const char *uri, const char *loginId, const char *key)</div></div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md36"></a>
### 1.1. High Availability Considerations</h1>
<p>The aim of this feature in SDK is to enable the user to send requests to all configured gateways where first successful response will be returned.</p>
<p>There are interfaces for each asynchronous service provider respectivelly.</p>
<div class="fragment"><div class="line"><a class="code" href="../../df/d8a/group__ksi__types.html#gad84c59bd3c6db9e15422f210fca7c695">KSI_AsyncService</a> *service = NULL; <span class="comment">/* Must be freed. */</span></div>
<div class="line"> </div>
<div class="line"><a class="code" href="../../d4/db6/group__asyncNetwork.html#gaf302badcf8ba351c1a47685c979ba696">KSI_SigningHighAvailabilityService_new</a>(ksi, &amp;service);</div>
<div class="ttc" id="agroup__asyncNetwork_html_gaf302badcf8ba351c1a47685c979ba696"><div class="ttname"><a href="../../d4/db6/group__asyncNetwork.html#gaf302badcf8ba351c1a47685c979ba696">KSI_SigningHighAvailabilityService_new</a></div><div class="ttdeci">int KSI_SigningHighAvailabilityService_new(KSI_CTX *ctx, KSI_AsyncService **service)</div></div>
</div><!-- fragment --><p> (see <a class="el" href="../../d4/db6/group__asyncNetwork.html#ga55b2535b6d6961160c6cc70ec53f5d40">KSI_ExtendingHighAvailabilityService_new</a> for extending)</p>
<p>You can configure several service locations to send the request to (at least one must be configured). Let's assume you would like to configure three sub services with following addresses:</p><ul>
<li><code>ksi+tcp</code>://service.somehost1:1234 and it is authenticated by <code>user1:key1</code>.</li>
<li><code>ksi+tcp</code>://service.somehost1:2345 and it is authenticated by <code>user2:key2</code>.</li>
<li><code>ksi+tcp</code>://service.somehost1:3456 and it is authenticated by <code>user3:key3</code>.</li>
</ul>
<div class="fragment"><div class="line"><a class="code" href="../../d4/db6/group__asyncNetwork.html#gaad6c5ece58ffdc690488e812afbec902">KSI_AsyncService_addEndpoint</a>(service, <span class="stringliteral">&quot;ksi+tcp://service.somehost1:1234&quot;</span>, <span class="stringliteral">&quot;user1&quot;</span>, <span class="stringliteral">&quot;key1&quot;</span>);</div>
<div class="line"><a class="code" href="../../d4/db6/group__asyncNetwork.html#gaad6c5ece58ffdc690488e812afbec902">KSI_AsyncService_addEndpoint</a>(service, <span class="stringliteral">&quot;ksi+tcp://service.somehost2:2345&quot;</span>, <span class="stringliteral">&quot;user2&quot;</span>, <span class="stringliteral">&quot;key2&quot;</span>);</div>
<div class="line"><a class="code" href="../../d4/db6/group__asyncNetwork.html#gaad6c5ece58ffdc690488e812afbec902">KSI_AsyncService_addEndpoint</a>(service, <span class="stringliteral">&quot;ksi+tcp://service.somehost3:3456&quot;</span>, <span class="stringliteral">&quot;user3&quot;</span>, <span class="stringliteral">&quot;key3&quot;</span>);</div>
<div class="ttc" id="agroup__asyncNetwork_html_gaad6c5ece58ffdc690488e812afbec902"><div class="ttname"><a href="../../d4/db6/group__asyncNetwork.html#gaad6c5ece58ffdc690488e812afbec902">KSI_AsyncService_addEndpoint</a></div><div class="ttdeci">int KSI_AsyncService_addEndpoint(KSI_AsyncService *service, const char *uri, const char *loginId, const char *key)</div></div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md37"></a>
## 2. Additional Options</h1>
<p>In order to adjust the <a class="el" href="../../df/d8a/group__ksi__types.html#gad84c59bd3c6db9e15422f210fca7c695">KSI_AsyncService</a> to meet your needs, <a class="el" href="../../d4/db6/group__asyncNetwork.html#ga06ce63c85a9f1b66bc7acaa6e6ff9358">KSI_AsyncService_setOption</a> should be used. The available options are described under <a class="el" href="../../d4/db6/group__asyncNetwork.html#ga40e650b7f84cc3ca868d0e63fd2a6d94">KSI_AsyncOption</a>. Pay attention to the parameter type description. The updated parameters affect all transfers.</p>
<p>The throughput of added requests is controlled via two options:</p><ul>
<li><a class="el" href="../../d4/db6/group__asyncNetwork.html#ggabb8f4dd7540f4eed4481b4268cc848c6aa45d983503acdc33f8b7c2ad408b8c6c">KSI_ASYNC_OPT_REQUEST_CACHE_SIZE</a> option controls how many request are open in parallel. In case the maximum number of requests is already added to the <a class="el" href="../../df/d8a/group__ksi__types.html#gad84c59bd3c6db9e15422f210fca7c695">KSI_AsyncService</a>, the next invocation of <a class="el" href="../../d4/db6/group__asyncNetwork.html#gafe7e7439039a572ec6d1f56e378cb248">KSI_AsyncService_addRequest</a> will return an error code <a class="el" href="../../dd/df2/group__base.html#gga80cba280da561d1b02728cd946645197ab20a65026cddb76243e0e076e416ee18">KSI_ASYNC_REQUEST_CACHE_FULL</a>. In this case the implementation code should call <a class="el" href="../../d4/db6/group__asyncNetwork.html#ga6e8d697c1ba5b0748626072989ecfbb6">KSI_AsyncService_run</a> in order to read out received responses and free up cache in <a class="el" href="../../df/d8a/group__ksi__types.html#gad84c59bd3c6db9e15422f210fca7c695">KSI_AsyncService</a>.</li>
</ul>
<div class="fragment"><div class="line"><span class="keywordtype">size_t</span> count = (1 &lt;&lt; 10);</div>
<div class="line"> </div>
<div class="line"><a class="code" href="../../d4/db6/group__asyncNetwork.html#ga06ce63c85a9f1b66bc7acaa6e6ff9358">KSI_AsyncService_setOption</a>(as, <a class="code" href="../../d4/db6/group__asyncNetwork.html#ggabb8f4dd7540f4eed4481b4268cc848c6aa45d983503acdc33f8b7c2ad408b8c6c">KSI_ASYNC_OPT_REQUEST_CACHE_SIZE</a>, (<span class="keywordtype">void</span> *)count);</div>
<div class="ttc" id="agroup__asyncNetwork_html_ga06ce63c85a9f1b66bc7acaa6e6ff9358"><div class="ttname"><a href="../../d4/db6/group__asyncNetwork.html#ga06ce63c85a9f1b66bc7acaa6e6ff9358">KSI_AsyncService_setOption</a></div><div class="ttdeci">int KSI_AsyncService_setOption(KSI_AsyncService *s, const int option, void *value)</div></div>
<div class="ttc" id="agroup__asyncNetwork_html_ggabb8f4dd7540f4eed4481b4268cc848c6aa45d983503acdc33f8b7c2ad408b8c6c"><div class="ttname"><a href="../../d4/db6/group__asyncNetwork.html#ggabb8f4dd7540f4eed4481b4268cc848c6aa45d983503acdc33f8b7c2ad408b8c6c">KSI_ASYNC_OPT_REQUEST_CACHE_SIZE</a></div><div class="ttdeci">@ KSI_ASYNC_OPT_REQUEST_CACHE_SIZE</div><div class="ttdef"><b>Definition:</b> net_async.h:506</div></div>
</div><!-- fragment --><ul>
<li><a class="el" href="../../d4/db6/group__asyncNetwork.html#ggabb8f4dd7540f4eed4481b4268cc848c6a67e923fc3d62b3e4753920f08957c940">KSI_ASYNC_OPT_MAX_REQUEST_COUNT</a> option defines the maximum number of request to be sent during a predefined time interval (also round). The value should not exceed KSI aggregation service provider configuration (see <a class="el" href="../../dd/df2/group__base.html#ga1141a4a271ff3a033561e6d312097c95">KSI_receiveAggregatorConfig</a>). The round interval can not be changed by the user and is set internally to 1 sec.</li>
</ul>
<div class="fragment"><div class="line"><span class="keywordtype">size_t</span> count = (1 &lt;&lt; 8);</div>
<div class="line"> </div>
<div class="line"><a class="code" href="../../d4/db6/group__asyncNetwork.html#ga06ce63c85a9f1b66bc7acaa6e6ff9358">KSI_AsyncService_setOption</a>(as, <a class="code" href="../../d4/db6/group__asyncNetwork.html#ggabb8f4dd7540f4eed4481b4268cc848c6a67e923fc3d62b3e4753920f08957c940">KSI_ASYNC_OPT_MAX_REQUEST_COUNT</a>, (<span class="keywordtype">void</span> *)count);</div>
<div class="ttc" id="agroup__asyncNetwork_html_ggabb8f4dd7540f4eed4481b4268cc848c6a67e923fc3d62b3e4753920f08957c940"><div class="ttname"><a href="../../d4/db6/group__asyncNetwork.html#ggabb8f4dd7540f4eed4481b4268cc848c6a67e923fc3d62b3e4753920f08957c940">KSI_ASYNC_OPT_MAX_REQUEST_COUNT</a></div><div class="ttdeci">@ KSI_ASYNC_OPT_MAX_REQUEST_COUNT</div><div class="ttdef"><b>Definition:</b> net_async.h:515</div></div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md38"></a>
## 3. Creating a Request</h1>
<p>Unlike the basic interface, the asynchronous interface is non-blocking (except DNS resolution). This enables the user to do several simultaneous transfers in parallel, each single transfer is wrapped into <a class="el" href="../../df/d8a/group__ksi__types.html#ga3834e5d80323aa5847c14362b41e3c72">KSI_AsyncHandle</a>.</p>
<h1><a class="anchor" id="autotoc_md39"></a>
### 3.1. Signing</h1>
<p>Provide a signing <code>request</code> <a class="el" href="../../df/d8a/group__ksi__types.html#ga7ccb07384147d5b6e69ca2cf1afa6f7e">KSI_AggregationReq</a>.</p>
<div class="fragment"><div class="line"><a class="code" href="../../df/d8a/group__ksi__types.html#ga3834e5d80323aa5847c14362b41e3c72">KSI_AsyncHandle</a> *handle = NULL;</div>
<div class="line"> </div>
<div class="line"><a class="code" href="../../d4/db6/group__asyncNetwork.html#gabf5e77f6e2820e9f8b4591610e103de4">KSI_AsyncAggregationHandle_new</a>(ksi, request, &amp;handle);</div>
<div class="ttc" id="agroup__asyncNetwork_html_gabf5e77f6e2820e9f8b4591610e103de4"><div class="ttname"><a href="../../d4/db6/group__asyncNetwork.html#gabf5e77f6e2820e9f8b4591610e103de4">KSI_AsyncAggregationHandle_new</a></div><div class="ttdeci">int KSI_AsyncAggregationHandle_new(KSI_CTX *ctx, KSI_AggregationReq *req, KSI_AsyncHandle **o)</div></div>
<div class="ttc" id="agroup__ksi__types_html_ga3834e5d80323aa5847c14362b41e3c72"><div class="ttname"><a href="../../df/d8a/group__ksi__types.html#ga3834e5d80323aa5847c14362b41e3c72">KSI_AsyncHandle</a></div><div class="ttdeci">struct KSI_AsyncHandle_st KSI_AsyncHandle</div><div class="ttdef"><b>Definition:</b> types.h:127</div></div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md40"></a>
### 3.2. Extending</h1>
<p>There are two interfaces for constructing an extending <code>handle:</code> </p>
<ul>
<li>providing an <a class="el" href="../../df/d8a/group__ksi__types.html#ga1590bf3d94a9c74f5e52571dd32dcc9f">KSI_ExtendReq</a>. From user point of view, the drawback of using this interface is that you will not be able to get a <a class="el" href="../../df/d8a/group__ksi__types.html#gaec1ceb681237b74b978a661bb3224cb2">KSI_Signature</a> from the response handle.</li>
</ul>
<div class="fragment"><div class="line"><a class="code" href="../../df/d8a/group__ksi__types.html#ga3834e5d80323aa5847c14362b41e3c72">KSI_AsyncHandle</a> *handle = NULL;</div>
<div class="line"> </div>
<div class="line"><a class="code" href="../../d4/db6/group__asyncNetwork.html#gab97597f1a759164b4305d10e85e995bd">KSI_AsyncExtendHandle_new</a>(ksi, request, &amp;handle);</div>
<div class="ttc" id="agroup__asyncNetwork_html_gab97597f1a759164b4305d10e85e995bd"><div class="ttname"><a href="../../d4/db6/group__asyncNetwork.html#gab97597f1a759164b4305d10e85e995bd">KSI_AsyncExtendHandle_new</a></div><div class="ttdeci">int KSI_AsyncExtendHandle_new(KSI_CTX *ctx, KSI_ExtendReq *req, KSI_AsyncHandle **o)</div></div>
</div><!-- fragment --><ul>
<li>providing a <a class="el" href="../../df/d8a/group__ksi__types.html#gaec1ceb681237b74b978a661bb3224cb2">KSI_Signature</a> and optionally a <a class="el" href="../../df/d8a/group__ksi__types.html#ga87cee33f26e5f93a40d281eff0d15168">KSI_PublicationRecord</a>. In case the publication record is not provided, the <code>signature</code> will be extended to the nearest publication. Note that the input data may not be freed until the request has received a response.</li>
</ul>
<div class="fragment"><div class="line"><a class="code" href="../../df/d8a/group__ksi__types.html#ga3834e5d80323aa5847c14362b41e3c72">KSI_AsyncHandle</a> *handle = NULL;</div>
<div class="line"> </div>
<div class="line"><a class="code" href="../../d4/db6/group__asyncNetwork.html#ga17a5c91cae8930c291d0a7ce4324524d">KSI_AsyncExtendingHandle_new</a>(ksi, signature, publicationRecond, &amp;handle);</div>
<div class="ttc" id="agroup__asyncNetwork_html_ga17a5c91cae8930c291d0a7ce4324524d"><div class="ttname"><a href="../../d4/db6/group__asyncNetwork.html#ga17a5c91cae8930c291d0a7ce4324524d">KSI_AsyncExtendingHandle_new</a></div><div class="ttdeci">int KSI_AsyncExtendingHandle_new(KSI_CTX *ctx, const KSI_Signature *sig, const KSI_PublicationRecord *pubRec, KSI_AsyncHandle **o)</div></div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md41"></a>
### 3.3. Setting Up The Request</h1>
<p>Additionally, user's private data can be added to the handle, which is associated with the request.</p>
<div class="fragment"><div class="line"><a class="code" href="../../d4/db6/group__asyncNetwork.html#gaccf4e18520cde00e785ec4393ec31e92">KSI_AsyncHandle_setRequestCtx</a>(handle, (<span class="keywordtype">void</span> *)p_data, (<span class="keywordtype">void</span> (*)(<span class="keywordtype">void</span> *))data_free);</div>
<div class="ttc" id="agroup__asyncNetwork_html_gaccf4e18520cde00e785ec4393ec31e92"><div class="ttname"><a href="../../d4/db6/group__asyncNetwork.html#gaccf4e18520cde00e785ec4393ec31e92">KSI_AsyncHandle_setRequestCtx</a></div><div class="ttdeci">int KSI_AsyncHandle_setRequestCtx(KSI_AsyncHandle *o, void *reqCtx, void(*reqCtx_free)(void *))</div></div>
</div><!-- fragment --><p>When the <a class="el" href="../../df/d8a/group__ksi__types.html#ga3834e5d80323aa5847c14362b41e3c72">KSI_AsyncHandle</a> is set up, add it to the asynchronous service provider <a class="el" href="../../df/d8a/group__ksi__types.html#gad84c59bd3c6db9e15422f210fca7c695">KSI_AsyncService</a> by invoking <a class="el" href="../../d4/db6/group__asyncNetwork.html#gafe7e7439039a572ec6d1f56e378cb248">KSI_AsyncService_addRequest</a>. You may add multiple <a class="el" href="../../df/d8a/group__ksi__types.html#ga3834e5d80323aa5847c14362b41e3c72">KSI_AsyncHandle</a>'s at any time.</p>
<div class="fragment"><div class="line"><a class="code" href="../../d4/db6/group__asyncNetwork.html#gafe7e7439039a572ec6d1f56e378cb248">KSI_AsyncService_addRequest</a>(service, handle);</div>
<div class="ttc" id="agroup__asyncNetwork_html_gafe7e7439039a572ec6d1f56e378cb248"><div class="ttname"><a href="../../d4/db6/group__asyncNetwork.html#gafe7e7439039a572ec6d1f56e378cb248">KSI_AsyncService_addRequest</a></div><div class="ttdeci">int KSI_AsyncService_addRequest(KSI_AsyncService *service, KSI_AsyncHandle *handle)</div></div>
</div><!-- fragment --><p>Adding the handles to the service provider does not start the transfer automatically. The idea of the asynchronous API is that the user implementation controls every aspect of the query. In order to initiate the transfer, you must invoke <a class="el" href="../../d4/db6/group__asyncNetwork.html#ga6e8d697c1ba5b0748626072989ecfbb6">KSI_AsyncService_run</a>. It is not guaranteed that all added handles will be processed during a call to <a class="el" href="../../d4/db6/group__asyncNetwork.html#ga6e8d697c1ba5b0748626072989ecfbb6">KSI_AsyncService_run</a>.</p>
<p>Any info regarding the request is returned from the asynchronous service provider via <a class="el" href="../../d4/db6/group__asyncNetwork.html#ga6e8d697c1ba5b0748626072989ecfbb6">KSI_AsyncService_run</a> input parameters. Any completed request is returned via the input parameter <code>handle</code>, and the number of pending request via the input parameter <code>waiting</code>. In order to process all requests, the run method should be invoked as long as there are pending requests left.</p>
<p>The type of data contained in the returned handle can be determined via <a class="el" href="../../d4/db6/group__asyncNetwork.html#gace27f8324c4043b778058c936153b626">KSI_AsyncHandle_getState</a>. The returned <code>state</code> can be any of the final states described in <a class="el" href="../../d4/db6/group__asyncNetwork.html#ga23b8116b66a1f61aabb0814686058d4f">KSI_AsyncHandleState</a>, eg:</p><ul>
<li><a class="el" href="../../d4/db6/group__asyncNetwork.html#gga9055a6858d4787c803b011d9030c8834ab54c38928757165e2041d594e885177a">KSI_ASYNC_STATE_RESPONSE_RECEIVED</a> for an aggregation response</li>
<li><a class="el" href="../../d4/db6/group__asyncNetwork.html#gga9055a6858d4787c803b011d9030c8834a1f306911687c35a0c4b2c6dee4a091bc">KSI_ASYNC_STATE_ERROR</a> for an error status</li>
</ul>
<div class="fragment"><div class="line"><span class="keywordflow">do</span> {</div>
<div class="line">        <a class="code" href="../../df/d8a/group__ksi__types.html#ga3834e5d80323aa5847c14362b41e3c72">KSI_AsyncHandle</a> *handle = NULL; <span class="comment">/* Must be freed. */</span></div>
<div class="line"> </div>
<div class="line">        <a class="code" href="../../d4/db6/group__asyncNetwork.html#ga6e8d697c1ba5b0748626072989ecfbb6">KSI_AsyncService_run</a>(service, &amp;handle, &amp;pending);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (handle != NULL) {</div>
<div class="line">                <span class="keywordtype">int</span> state = <a class="code" href="../../d4/db6/group__asyncNetwork.html#gga9055a6858d4787c803b011d9030c8834ae26ea3fc65599e845d9c6654391b920d">KSI_ASYNC_STATE_UNDEFINED</a>;</div>
<div class="line"> </div>
<div class="line">                <a class="code" href="../../d4/db6/group__asyncNetwork.html#gace27f8324c4043b778058c936153b626">KSI_AsyncHandle_getState</a>(handle, &amp;state);</div>
<div class="line"> </div>
<div class="line">                <span class="keywordflow">switch</span> (state) {</div>
<div class="line">                        <span class="keywordflow">case</span> <a class="code" href="../../d4/db6/group__asyncNetwork.html#gga9055a6858d4787c803b011d9030c8834ab54c38928757165e2041d594e885177a">KSI_ASYNC_STATE_RESPONSE_RECEIVED</a>: {</div>
<div class="line">                                        ...</div>
<div class="line">                                }</div>
<div class="line">                                <span class="keywordflow">break</span>;</div>
<div class="line">                        <span class="keywordflow">case</span> <a class="code" href="../../d4/db6/group__asyncNetwork.html#gga9055a6858d4787c803b011d9030c8834a1f306911687c35a0c4b2c6dee4a091bc">KSI_ASYNC_STATE_ERROR</a>: {</div>
<div class="line">                                        ...</div>
<div class="line">                                }</div>
<div class="line">                                <span class="keywordflow">break</span>;</div>
<div class="line">                }</div>
<div class="line"> </div>
<div class="line">                <a class="code" href="../../d4/db6/group__asyncNetwork.html#gada85b79595f6a6a26a376dd47eaf641f">KSI_AsyncHandle_free</a>(handle);</div>
<div class="line">        }</div>
<div class="line">} (pending);</div>
<div class="ttc" id="agroup__asyncNetwork_html_ga6e8d697c1ba5b0748626072989ecfbb6"><div class="ttname"><a href="../../d4/db6/group__asyncNetwork.html#ga6e8d697c1ba5b0748626072989ecfbb6">KSI_AsyncService_run</a></div><div class="ttdeci">int KSI_AsyncService_run(KSI_AsyncService *service, KSI_AsyncHandle **handle, size_t *waiting)</div></div>
<div class="ttc" id="agroup__asyncNetwork_html_gace27f8324c4043b778058c936153b626"><div class="ttname"><a href="../../d4/db6/group__asyncNetwork.html#gace27f8324c4043b778058c936153b626">KSI_AsyncHandle_getState</a></div><div class="ttdeci">int KSI_AsyncHandle_getState(const KSI_AsyncHandle *h, int *state)</div></div>
<div class="ttc" id="agroup__asyncNetwork_html_gada85b79595f6a6a26a376dd47eaf641f"><div class="ttname"><a href="../../d4/db6/group__asyncNetwork.html#gada85b79595f6a6a26a376dd47eaf641f">KSI_AsyncHandle_free</a></div><div class="ttdeci">void KSI_AsyncHandle_free(KSI_AsyncHandle *o)</div></div>
<div class="ttc" id="agroup__asyncNetwork_html_gga9055a6858d4787c803b011d9030c8834a1f306911687c35a0c4b2c6dee4a091bc"><div class="ttname"><a href="../../d4/db6/group__asyncNetwork.html#gga9055a6858d4787c803b011d9030c8834a1f306911687c35a0c4b2c6dee4a091bc">KSI_ASYNC_STATE_ERROR</a></div><div class="ttdeci">@ KSI_ASYNC_STATE_ERROR</div><div class="ttdef"><b>Definition:</b> net_async.h:378</div></div>
<div class="ttc" id="agroup__asyncNetwork_html_gga9055a6858d4787c803b011d9030c8834ab54c38928757165e2041d594e885177a"><div class="ttname"><a href="../../d4/db6/group__asyncNetwork.html#gga9055a6858d4787c803b011d9030c8834ab54c38928757165e2041d594e885177a">KSI_ASYNC_STATE_RESPONSE_RECEIVED</a></div><div class="ttdeci">@ KSI_ASYNC_STATE_RESPONSE_RECEIVED</div><div class="ttdef"><b>Definition:</b> net_async.h:363</div></div>
<div class="ttc" id="agroup__asyncNetwork_html_gga9055a6858d4787c803b011d9030c8834ae26ea3fc65599e845d9c6654391b920d"><div class="ttname"><a href="../../d4/db6/group__asyncNetwork.html#gga9055a6858d4787c803b011d9030c8834ae26ea3fc65599e845d9c6654391b920d">KSI_ASYNC_STATE_UNDEFINED</a></div><div class="ttdeci">@ KSI_ASYNC_STATE_UNDEFINED</div><div class="ttdef"><b>Definition:</b> net_async.h:339</div></div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md42"></a>
## 4. Saving</h1>
<p>In case of a succesful response, the KSI signature can be extracted from the handle by invoking <a class="el" href="../../d4/db6/group__asyncNetwork.html#gaaa39c6abc94906c10fac5792b91f98a8">KSI_AsyncHandle_getSignature</a>.</p>
<div class="fragment"><div class="line"><a class="code" href="../../df/d8a/group__ksi__types.html#gaec1ceb681237b74b978a661bb3224cb2">KSI_Signature</a> *signature = NULL; <span class="comment">/* Must be freed. */</span></div>
<div class="line"> </div>
<div class="line"><a class="code" href="../../d4/db6/group__asyncNetwork.html#gaaa39c6abc94906c10fac5792b91f98a8">KSI_AsyncHandle_getSignature</a>(handle, &amp;signature);</div>
<div class="ttc" id="agroup__asyncNetwork_html_gaaa39c6abc94906c10fac5792b91f98a8"><div class="ttname"><a href="../../d4/db6/group__asyncNetwork.html#gaaa39c6abc94906c10fac5792b91f98a8">KSI_AsyncHandle_getSignature</a></div><div class="ttdeci">int KSI_AsyncHandle_getSignature(const KSI_AsyncHandle *h, KSI_Signature **signature)</div></div>
<div class="ttc" id="agroup__ksi__types_html_gaec1ceb681237b74b978a661bb3224cb2"><div class="ttname"><a href="../../df/d8a/group__ksi__types.html#gaec1ceb681237b74b978a661bb3224cb2">KSI_Signature</a></div><div class="ttdeci">struct KSI_Signature_st KSI_Signature</div><div class="ttdef"><b>Definition:</b> types.h:67</div></div>
</div><!-- fragment --><p>To save the signature to a file or database it's content needs to be serialized. For this, call the <a class="el" href="../../da/d4f/group__signature.html#gae952af5c5d65b8e64bff387627202592">KSI_Signature_serialize</a> method.</p>
<div class="fragment"><div class="line"><span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *serialized = NULL; <span class="comment">/* Must be freed. */</span></div>
<div class="line"><span class="keywordtype">size_t</span> serialized_len;</div>
<div class="line"> </div>
<div class="line"><a class="code" href="../../da/d4f/group__signature.html#gae952af5c5d65b8e64bff387627202592">KSI_Signature_serialize</a>(sig, &amp;serialized, &amp;serialized_len);</div>
<div class="ttc" id="agroup__signature_html_gae952af5c5d65b8e64bff387627202592"><div class="ttname"><a href="../../da/d4f/group__signature.html#gae952af5c5d65b8e64bff387627202592">KSI_Signature_serialize</a></div><div class="ttdeci">int KSI_Signature_serialize(const KSI_Signature *sig, unsigned char **raw, size_t *raw_len)</div></div>
</div><!-- fragment --><p>Now you may store the contents of <code>serialized</code> with length <code>serialized_len</code> how ever needed.</p>
<h1><a class="anchor" id="autotoc_md43"></a>
## 5. Cleanup</h1>
<p>As the final step, you need to free all the allocated resources.</p>
<p>The returned handle from <a class="el" href="../../d4/db6/group__asyncNetwork.html#ga6e8d697c1ba5b0748626072989ecfbb6">KSI_AsyncService_run</a> must be freed after it has been processed.</p>
<div class="fragment"><div class="line"><a class="code" href="../../d4/db6/group__asyncNetwork.html#gada85b79595f6a6a26a376dd47eaf641f">KSI_AsyncHandle_free</a>(handle);</div>
</div><!-- fragment --><p>Also the extracted signature from <a class="el" href="../../df/d8a/group__ksi__types.html#ga3834e5d80323aa5847c14362b41e3c72">KSI_AsyncHandle</a> must be freed.</p>
<div class="fragment"><div class="line"><a class="code" href="../../da/d4f/group__signature.html#ga4d14e3cb5ca06780d492746d58de92dd">KSI_Signature_free</a>(signature);</div>
<div class="ttc" id="agroup__signature_html_ga4d14e3cb5ca06780d492746d58de92dd"><div class="ttname"><a href="../../da/d4f/group__signature.html#ga4d14e3cb5ca06780d492746d58de92dd">KSI_Signature_free</a></div><div class="ttdeci">void KSI_Signature_free(KSI_Signature *signature)</div></div>
</div><!-- fragment --><p>Note that the KSI context may be reused as much as needed (within a single thread) and must not be created every time. Also, the context must be freed last.</p>
<div class="fragment"><div class="line"><a class="code" href="../../d4/db6/group__asyncNetwork.html#ga8184230d3ed8d3148e845f7ea1dde227">KSI_AsyncService_free</a>(service);</div>
<div class="line"><a class="code" href="../../dd/df2/group__base.html#ga40d9e85aa8b1bd9218e8395e5a79838a">KSI_CTX_free</a>(ksi); <span class="comment">/* Must be freed last. */</span></div>
<div class="ttc" id="agroup__asyncNetwork_html_ga8184230d3ed8d3148e845f7ea1dde227"><div class="ttname"><a href="../../d4/db6/group__asyncNetwork.html#ga8184230d3ed8d3148e845f7ea1dde227">KSI_AsyncService_free</a></div><div class="ttdeci">void KSI_AsyncService_free(KSI_AsyncService *service)</div></div>
<div class="ttc" id="agroup__base_html_ga40d9e85aa8b1bd9218e8395e5a79838a"><div class="ttname"><a href="../../dd/df2/group__base.html#ga40d9e85aa8b1bd9218e8395e5a79838a">KSI_CTX_free</a></div><div class="ttdeci">void KSI_CTX_free(KSI_CTX *ctx)</div></div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>
